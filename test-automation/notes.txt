# INTERVAL is 15s it comes from prometheus scrape interval (we only have data every 15s, so in order to get time interval we need sum values * 15 (probe_success is 1 or 0))

# Range is 30m --> should be the length of the test

##############################
#### Backend availability ####
##############################

curl "http://localhost:9090/api/v1/query?query=$( urlencode 'avg_over_time(probe_success{instance=~".*kubedepend-backend.*"}[15s])' )" | jq .data.result[0].value[1]

curl "http://localhost:9090/api/v1/query?query=$( urlencode 'avg_over_time(probe_success{instance=~".*kubedepend-backend.*"}[${INTERVAL}])' )" | jq .data.result[0].value[1]

##################################
#### Backend not availability ####
#################################

curl "http://localhost:9090/api/v1/query?query=$( urlencode '(1 - sum_over_time(probe_success{instance=~".*kubedepend-backend.*"}[${INTERVAL}])) / count_over_time(probe_success{instance=~".*kubedepend-backend.*"}[${INTERVAL}])' )" | jq .

curl "http://localhost:9090/api/v1/query?query=$( urlencode '(1 - sum_over_time(probe_success{instance=~".*kubedepend-backend.*"}[15s])) / count_over_time(probe_success{instance=~".*kubedepend-backend.*"}[15s])' )" | jq .

######################
#### Backend MUT #####
######################

curl "http://localhost:9090/api/v1/query?query=$( urlencode '15 * sum_over_time(probe_success{instance=~".*kubedepend-backend.*"}[${RANGE}]) / (floor((changes(probe_success{instance=~".*kubedepend-backend.*"}[${RANGE}]) + 1 + probe_success{instance=~".*kubedepend-backend.*"} offset ${RANGE}) / 2))' )" | jq .

curl "http://localhost:9090/api/v1/query?query=$( urlencode '15 * sum_over_time(probe_success{instance=~".*kubedepend-backend.*"}[30m]) / (floor((changes(probe_success{instance=~".*kubedepend-backend.*"}[30m]) + 1 + probe_success{instance=~".*kubedepend-backend.*"} offset 30m) / 2))' )" | jq .

######################
#### Backend MDT #####
######################

curl "http://localhost:9090/api/v1/query?query=$( urlencode '15 * (count_over_time(probe_success{instance=~".*kubedepend-backend.*"}[${RANGE}]) - sum_over_time(probe_success{instance=~".*kubedepend-backend.*"}[${RANGE}])) / (floor((changes(probe_success{instance=~".*kubedepend-backend.*"}[${RANGE}]) + 2 - probe_success{instance=~".*kubedepend-backend.*"} offset ${RANGE}) / 2))' )" | jq .

curl "http://localhost:9090/api/v1/query?query=$( urlencode '15 * (count_over_time(probe_success{instance=~".*kubedepend-backend.*"}[30m]) - sum_over_time(probe_success{instance=~".*kubedepend-backend.*"}[30m])) / (floor((changes(probe_success{instance=~".*kubedepend-backend.*"}[30m]) + 2 - probe_success{instance=~".*kubedepend-backend.*"} offset 30m) / 2))' )" | jq .

######################
#### Backend MTBF ####
######################

curl "http://localhost:9090/api/v1/query?query=$( urlencode 'sum_over_time(probe_success{instance=~".*kubedepend-backend.*"}[${RANGE}]) / (floor((changes(probe_success{instance=~".*kubedepend-backend.*"}[${RANGE}]) + 1 + probe_success{instance=~".*kubedepend-backend.*"} offset ${RANGE}) / 2)) + count_over_time(probe_success{instance=~".*kubedepend-backend.*"}[${RANGE}]) - sum_over_time(probe_success{instance=~".*kubedepend-backend.*"}[${RANGE}]) / (floor((changes(probe_success{instance=~".*kubedepend-backend.*"}[${RANGE}]) + 2 - probe_success{instance=~".*kubedepend-backend.*"} offset ${RANGE}) / 2))' )" | jq .

curl "http://localhost:9090/api/v1/query?query=$( urlencode 'sum_over_time(probe_success{instance=~".*kubedepend-backend.*"}[30m]) / (floor((changes(probe_success{instance=~".*kubedepend-backend.*"}[30m]) + 1 + probe_success{instance=~".*kubedepend-backend.*"} offset 30m) / 2)) + count_over_time(probe_success{instance=~".*kubedepend-backend.*"}[30m]) - sum_over_time(probe_success{instance=~".*kubedepend-backend.*"}[30m]) / (floor((changes(probe_success{instance=~".*kubedepend-backend.*"}[30m]) + 2 - probe_success{instance=~".*kubedepend-backend.*"} offset 30m) / 2))' )" | jq .